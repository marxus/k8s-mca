# MCA (Multi Cluster Adapter)

MCA is a Kubernetes sidecar that acts as a MITM proxy for API calls. It intercepts requests by overriding `KUBERNETES_SERVICE_HOST/PORT` to redirect traffic through a local proxy at `127.0.0.1:6443`.

## Purpose

The final goal of MCA is to enable **multi-cluster operations** by routing different API calls to different API servers. MCA will inspect API requests and route them based on manifest labels and other criteria, allowing existing applications to function across multiple clusters without modification by wrapping them with the MCA sidecar.

## Phase 1 Tasks (Current Cluster Only)

- [x] **MITM Proxy**: Intercepts and forwards Kubernetes API calls to current cluster
- [x] **Certificate Management**: Generates custom TLS certificates with SAN extensions  
- [x] **ServiceAccount Bypass**: Uses `automountServiceAccountToken: false` with manual volume mounting
- [x] **Pod Manifest Mutation**: Logic to add MCA sidecar to pod manifests `cat pod.yaml | go run cmd/mca/main.go --inject`
- [ ] **Admission Webhook**: Webhook server for automatic pod creation interception
- [ ] **Multi-cluster Configuration**: Support for multiple cluster configs
- [ ] **Routing Logic**: Route API calls based on inspection and manifest labels

## Usage

```bash
# Start MCA proxy server
export K8S_MCA_CTX=my-kube-context
go run cmd/mca/main.go --proxy

./kubectl.sh get pods -A # Test with MCA generated ServiceAccount
```

## Build Configurations

- **Release**: Production with in-cluster config and real filesystem
- **Development**: Local kubeconfig with sandboxed filesystem
- **Testing**: In-memory filesystem with no k8s context

## Testing

```bash
go test ./...
```

---

## Development Notes

This project was developed with assistance from Claude AI. Both the design phase and implementation conversations are exported and available for review. While the initial design was generated by Claude, it required significant fine-tuning. The codebase was heavily monitored during development, with some areas (like the `conf/` directory) having my own architectural touch. The effectiveness of my prompting approach remains uncertain, but the collaborative process proved productive.